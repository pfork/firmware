/**
  ************************************************************************************
  * @file    main.c
  * @author  stf
  * @version V0.0.1
  * @date    05-December-2013
  * @brief   This file contains the main init and then runs the mainloop
  ************************************************************************************
  */

#ifdef HAVE_MSC
#  include "dual.h"
#else
#  include "usb.h"
#endif // HAVE_MSC
#include "init.h"
#include "led.h"
#include "keys.h"
#include "randombytes_salsa20_random.h"
#include "mixer.h"
#include "pitchfork.h"
#include "systimer.h"
#include "oled.h"
#include <string.h>

void randombytes_salsa20_random_init(struct entropy_store* pool);
struct entropy_store* pool;

const uint8_t logo[] =
  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\xc0\xc0\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\xc0\xc0\xe0\xe0\xe0\xe0\xc0\xc0\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\x80\xc0\x00\x00\x00\x00\x00\x00\x80\xf3\xff\x7f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf0\xfc\x7e\x1f\x07\x03\x01\x00\x00\x00\x00\x01\x03\x07\x1f\xfe\xf8\xe0\x00\x00\x00\x00\x00\xf8\xf8\x18\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3c\x7c\xf0\xe0\xc0\x80\x00\x00\x00\x00\xf0\xf0\xe0\x80\xc0\xe0\xf8\x3f\x1f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x70\x78\xf0\xe0\xc0\xc0\xc0\xc0\xc0\xc0\xc0\xc3\xe7\xff\x7e\x78\xf8\xfc\x9f\x0f\x03\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3f\xff\xff\x80\x00\x00\x00\x00\xe0\xe0\xe0\x00\x00\x00\x00\x80\xff\xff\x7f\x00\x00\x00\x00\x00\x07\x1f\x3e\x78\x70\xe0\xc0\xc0\x80\x80\x80\x80\x80\x80\x80\xc0\xc0\xe0\xf8\x7c\x19\x01\x03\x03\x03\x03\x03\x03\x07\x1f\xff\xf9\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x01\x01\x01\x01\x01\x01\x01\x01\x00\x00\x00\x00\x01\x03\x0f\x1f\x3c\xf8\xf0\xc0\x80\x00\x00\x00\x00\x00\x00\x00\x00\x03\x0f\x1f\x3e\x78\x70\xe0\xff\xff\xe1\xe0\x70\x78\x3c\x1f\x0f\x03\x00\x00\x00\x00\x00\x00\x00\x00\x80\xe0\xf8\xff\x1f\x07\x01\x03\x03\x03\x03\x03\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x1f\xff\xfc\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x07\x0f\x1e\x7c\xf8\xe0\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x80\xf0\xfc\x7f\x1f\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x1f\xff\xfc\xe0\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
  "\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x63\x67\x7f\x7e\x7c\x70\x60\x60\x60\x60\x60\x7f\x7f\x63\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x70\x7e\x7f\x6f\x61\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x63\x7f\x7f\x7c\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60\x60" \
  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf0\x90\x90\x90\x90\x60\x00\x00\xf0\x00\x00\x10\x10\xf0\x10\x10\x00\xe0\x10\x10\x10\x10\x20\x00\x00\xf0\x80\x80\x80\x80\xf0\x00\x00\xf0\x90\x90\x90\x10\x00\xe0\x10\x10\x10\x10\xe0\x00\x00\xf0\x90\x90\x90\x90\x60\x00\x00\xf0\x80\x80\x40\x20\x10\x00\x00\xf0\x00\x00\xf0\x00\x00\xf0\xd0\xd0\xd0\xd0\x90\x00\x00\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
  "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x01\x01\x01\x01\x00\x00\x00\x07\x00\x00\x00\x00\x07\x00\x00\x00\x03\x04\x04\x04\x04\x02\x00\x00\x07\x01\x01\x01\x01\x07\x00\x00\x07\x01\x01\x01\x00\x00\x03\x04\x04\x04\x04\x03\x00\x00\x07\x01\x01\x01\x02\x04\x00\x00\x07\x01\x01\x01\x02\x04\x00\x00\x04\x00\x00\x04\x00\x00\x04\x04\x04\x04\x04\x03\x00\x00\x04\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" \
  ;

int main ( void ) {
#ifdef HAVE_MSC
  unsigned char kmask;
#endif // HAVE_MSC
  init();
  pool = init_pool();
  randombytes_salsa20_random_init(pool);

  bufs[0].start =  bufs[0].buf + crypto_secretbox_ZEROBYTES;
  bufs[1].start =  bufs[1].buf + crypto_secretbox_ZEROBYTES;

  memcpy(frame_buffer, logo, 1024);
  oled_refresh();

  while(1) {
    //usbd_poll(usbd_dev);
#ifdef HAVE_MSC
    if(dual_usb_mode == CRYPTO) handle_buf();
    oled_print(0,54, "5", Font_8x8);
    kmask = key_handler();
    oled_print(0,54, " ", Font_8x8);
    if(kmask & (1<<0)) {
      switch(dual_usb_mode) {
      case CRYPTO: { storage_mode(); oled_cmd(0xa7); break; }
      case DISK: { crypto_mode(); oled_cmd(0xa6); break; }
      }
    }
#endif // HAVE_MSC
    //led_handler(); // we have no leds on the pitchfork
    if(!(sysctr & 16383)) { // reseed about every 16s
      randombytes_salsa20_random_stir();
    }
  }
  return(0);
}
